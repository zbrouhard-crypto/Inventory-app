<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Vehicle Inventory</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f9; }
    header { background: #2a6ebb; color: white; padding: 1em; text-align: center; }
    nav { display: flex; justify-content: space-around; background: #ddd; padding: 0.5em; }
    nav button { padding: 0.5em 1em; border: none; border-radius: 8px; cursor: pointer; background: #fff; }
    nav button.active { background: #2a6ebb; color: white; }
    section { display: none; padding: 1em; }
    section.active { display: block; }
    .group, .part { border: 1px solid #ccc; border-radius: 8px; padding: 0.5em; margin: 0.5em 0; background: white; }
    .btn { background: #2a6ebb; color: white; border: none; padding: 0.5em 1em; border-radius: 8px; cursor: pointer; }
    .btn.danger { background: red; }
    #qr-reader { width: 100%; max-width: 400px; margin: auto; }
    #debug { font-size: 0.9em; color: darkred; margin-top: 1em; }
  </style>
  <!-- QR Code scanner library -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <header>
    <h1>Service Vehicle Inventory</h1>
  </header>
  <nav>
    <button onclick="showSection('home')" id="tab-home" class="active">Home</button>
    <button onclick="showSection('groups')" id="tab-groups">Groups</button>
    <button onclick="showSection('restock')" id="tab-restock">Restock</button>
    <button onclick="showSection('settings')" id="tab-settings">Settings</button>
  </nav>

  <section id="home" class="active">
    <h2>Welcome</h2>
    <button class="btn" onclick="startScanner()">üì∑ Scan QR Code</button>
    <div id="qr-reader" style="display:none;"></div>
    <div id="debug"></div>
    <p>Or browse manually:</p>
    <button class="btn" onclick="showSection('groups')">Browse Groups</button>
  </section>

  <section id="groups">
    <h2>Groups</h2>
    <div id="groups-list"></div>
  </section>

  <section id="restock">
    <h2>Restock List</h2>
    <ul id="restock-list"></ul>
    <button class="btn" onclick="replenishAll()">‚úÖ Replenish & Reset</button>
  </section>

  <section id="settings">
    <h2>Settings & Tools</h2>
    <button class="btn" onclick="exportData()">‚¨áÔ∏è Export JSON</button>
    <button class="btn" onclick="importData()">‚¨ÜÔ∏è Import JSON</button>
    <input type="file" id="fileInput" style="display:none" />
    <br/><br/>
    <button class="btn" onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
    <button class="btn" onclick="importCSV()">‚¨ÜÔ∏è Import CSV</button>
    <input type="file" id="csvInput" style="display:none" />
    <br/><br/>
    <button class="btn danger" onclick="confirmWipe()">üóëÔ∏è Wipe All Data</button>
  </section>

  <script>
    let inventory = {};
    let restockList = {};

    function showSection(id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.querySelector("#" + id).classList.add("active");
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      document.querySelector("#tab-" + id).classList.add("active");
    }

    function saveData() {
      localStorage.setItem("inventoryData", JSON.stringify(inventory));
      localStorage.setItem("restockData", JSON.stringify(restockList));
    }

    function loadData() {
      let inv = localStorage.getItem("inventoryData");
      let rest = localStorage.getItem("restockData");
      if (inv) inventory = JSON.parse(inv);
      if (rest) restockList = JSON.parse(rest);
      renderGroups();
      renderRestock();
    }

    function renderGroups() {
      let container = document.getElementById("groups-list");
      container.innerHTML = "";
      for (let g in inventory) {
        let groupDiv = document.createElement("div");
        groupDiv.className = "group";
        let title = document.createElement("h3");
        title.textContent = g;
        groupDiv.appendChild(title);
        inventory[g].forEach(p => {
          let partDiv = document.createElement("div");
          partDiv.className = "part";
          partDiv.textContent = p.name + " (" + p.qty + "/" + p.max + ")";
          partDiv.onclick = () => usePart(g, p.name);
          groupDiv.appendChild(partDiv);
        });
        container.appendChild(groupDiv);
      }
    }

    function usePart(group, part) {
      let item = inventory[group].find(p => p.name === part);
      if (item && item.qty > 0) {
        item.qty--;
        restockList[part] = (restockList[part] || 0) + 1;
        saveData();
        renderGroups();
        renderRestock();
      }
    }

    function renderRestock() {
      let ul = document.getElementById("restock-list");
      ul.innerHTML = "";
      for (let p in restockList) {
        let li = document.createElement("li");
        li.textContent = p + ": " + restockList[p];
        ul.appendChild(li);
      }
    }

    function replenishAll() {
      if (!confirm("Replenish all parts to full quantities?")) return;
      for (let g in inventory) {
        inventory[g].forEach(p => p.qty = p.max);
      }
      restockList = {};
      saveData();
      renderGroups();
      renderRestock();
    }

    function exportData() {
      let dataStr = JSON.stringify(inventory, null, 2);
      let blob = new Blob([dataStr], {type: "application/json"});
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url; a.download = "inventory.json"; a.click();
    }

    function importData() {
      document.getElementById("fileInput").click();
    }

    document.getElementById("fileInput").addEventListener("change", function(evt) {
      let file = evt.target.files[0];
      let reader = new FileReader();
      reader.onload = function(e) {
        inventory = JSON.parse(e.target.result);
        saveData();
        renderGroups();
      };
      reader.readAsText(file);
    });

    function exportCSV() {
      let rows = [["Group Name","Part Name","Max Quantity"]];
      for (let g in inventory) {
        inventory[g].forEach(p => {
          rows.push([g, p.name, p.max]);
        });
      }
      let csv = rows.map(r => r.join(",")).join("\n");
      let blob = new Blob([csv], {type:"text/csv"});
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url; a.download = "inventory.csv"; a.click();
    }

    function importCSV() {
      document.getElementById("csvInput").click();
    }

    document.getElementById("csvInput").addEventListener("change", function(evt) {
      let file = evt.target.files[0];
      let reader = new FileReader();
      reader.onload = function(e) {
        let lines = e.target.result.split(/\r?\n/);
        inventory = {};
        lines.slice(1).forEach(line => {
          if (!line.trim()) return;
          let [group, part, max] = line.split(",");
          if (!inventory[group]) inventory[group] = [];
          inventory[group].push({name: part, qty: parseInt(max), max: parseInt(max)});
        });
        saveData();
        renderGroups();
      };
      reader.readAsText(file);
    });

    function confirmWipe() {
      if (!confirm("‚ö†Ô∏è This will delete ALL data. Are you sure?")) return;
      if (!confirm("‚ö†Ô∏è Really wipe EVERYTHING?")) return;
      inventory = {};
      restockList = {};
      saveData();
      renderGroups();
      renderRestock();
    }

    // QR SCANNER
    function startScanner() {
      document.getElementById("qr-reader").style.display = "block";
      try {
        let html5QrcodeScanner = new Html5Qrcode("qr-reader");
        html5QrcodeScanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            document.getElementById("debug").textContent = "Scanned: " + qrCodeMessage;
            if (inventory[qrCodeMessage]) {
              showSection('groups');
              document.getElementById("groups-list").scrollIntoView();
            }
            html5QrcodeScanner.stop();
          },
          errorMessage => {
            document.getElementById("debug").textContent = "Scanning... " + errorMessage;
          }
        ).catch(err => {
          document.getElementById("debug").textContent = "Error starting scanner: " + err;
        });
      } catch (e) {
        document.getElementById("debug").textContent = "QR scanner not available: " + e;
      }
    }

    loadData();
  </script>
</body>
</html>