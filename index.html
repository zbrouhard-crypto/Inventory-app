<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Vehicle Inventory</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f9; }
    header { background: #333; color: #fff; padding: 1em; text-align: center; }
    nav { display: flex; justify-content: space-around; background: #444; }
    nav button { flex: 1; padding: 1em; border: none; background: #444; color: #fff; font-size: 1em; cursor: pointer; }
    nav button.active { background: #666; }
    section { display: none; padding: 1em; }
    section.active { display: block; }
    .group, .part { background: #fff; margin: .5em 0; padding: .5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn { padding: .5em 1em; margin: .25em; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #007bff; color: #fff; }
    .btn-danger { background: #dc3545; color: #fff; }
    .btn-secondary { background: #6c757d; color: #fff; }
  </style>
  <!-- QR scanner library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <!-- QR code generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <header><h1>Service Vehicle Inventory</h1></header>
  <nav>
    <button onclick="showSection('home')" id="homeTab" class="active">Home</button>
    <button onclick="showSection('groups')" id="groupsTab">Groups</button>
    <button onclick="showSection('restock')" id="restockTab">Restock</button>
    <button onclick="showSection('settings')" id="settingsTab">Settings</button>
  </nav>

  <section id="home" class="active">
    <h2>Welcome</h2>
    <p>Scan a QR code or browse groups manually.</p>
    <button class="btn btn-primary" onclick="startScanner()">Scan QR Code</button>
    <div id="qr-reader" style="width:100%; max-width:400px; margin:auto; display:none;"></div>
  </section>

  <section id="groups">
    <h2>Groups</h2>
    <div id="groupList"></div>
    <button class="btn btn-secondary" onclick="printAllQRCodes()">Print QR Codes</button>
  </section>

  <section id="restock">
    <h2>Restock List</h2>
    <div id="restockList"></div>
    <button class="btn btn-primary" onclick="clearRestock()">Clear Restock List</button>
    <button class="btn btn-danger" onclick="replenishStock()">Mark as Restocked</button>
  </section>

  <section id="settings">
    <h2>Settings</h2>
    <button class="btn btn-secondary" onclick="exportData()">Export JSON</button>
    <input type="file" id="importFile" onchange="importData(event)">
  </section>

  <script>
    let data = { groups: {} };
    let restock = {};

    function showSection(id) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      document.getElementById(id+"Tab").classList.add("active");
      if(id === "groups") renderGroups();
      if(id === "restock") renderRestock();
    }

    function renderGroups() {
      let container = document.getElementById("groupList");
      container.innerHTML = "";
      for (let g in data.groups) {
        let div = document.createElement("div");
        div.className = "group";
        div.innerHTML = `<h3>${g}</h3>`;
        let qrDiv = document.createElement("div");
        new QRCode(qrDiv, { text: g, width: 100, height: 100 });
        div.appendChild(qrDiv);
        data.groups[g].forEach((p,i) => {
          let partDiv = document.createElement("div");
          partDiv.className = "part";
          partDiv.innerHTML = `${p.name} - Qty: ${p.qty} <button class='btn btn-primary' onclick='usePart("${g}",${i})'>Use</button>`;
          div.appendChild(partDiv);
        });
        container.appendChild(div);
      }
    }

    function renderRestock() {
      let container = document.getElementById("restockList");
      container.innerHTML = "";
      for (let item in restock) {
        let div = document.createElement("div");
        div.className = "part";
        div.innerText = `${item} - Needed: ${restock[item]}`;
        container.appendChild(div);
      }
    }

    function usePart(group,index) {
      let part = data.groups[group][index];
      if (part.qty > 0) {
        part.qty--;
        restock[part.name] = (restock[part.name] || 0) + 1;
        saveData();
        renderGroups();
      }
    }

    function clearRestock() {
      if(confirm("Clear restock list?")) {
        restock = {};
        saveData();
        renderRestock();
      }
    }

    function replenishStock() {
      if(confirm("Mark all as restocked?")) {
        for (let g in data.groups) {
          data.groups[g].forEach(p => p.qty = p.max);
        }
        restock = {};
        saveData();
        renderGroups();
        renderRestock();
      }
    }

    function exportData() {
      let blob = new Blob([JSON.stringify(data)], {type: "application/json"});
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "inventory.json";
      a.click();
    }

    function importData(event) {
      let file = event.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(e) {
        data = JSON.parse(e.target.result);
        saveData();
        renderGroups();
      };
      reader.readAsText(file);
    }

    function saveData() {
      localStorage.setItem("inventoryData", JSON.stringify(data));
      localStorage.setItem("restockData", JSON.stringify(restock));
    }

    function loadData() {
      let d = localStorage.getItem("inventoryData");
      if(d) data = JSON.parse(d);
      let r = localStorage.getItem("restockData");
      if(r) restock = JSON.parse(r);
    }

    function startScanner() {
      document.getElementById("qr-reader").style.display = "block";
      let qrScanner = new Html5Qrcode("qr-reader");
      qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
        (decodedText) => {
          qrScanner.stop();
          document.getElementById("qr-reader").style.display = "none";
          if(data.groups[decodedText]) {
            showSection("groups");
            alert("Opened group: " + decodedText);
          } else {
            alert("QR code not recognized.");
          }
        },
        (error) => { console.log(error); }
      );
    }

    function printAllQRCodes() {
      let newWin = window.open("");
      newWin.document.write("<h1>Group QR Codes</h1>");
      for (let g in data.groups) {
        newWin.document.write(`<h2>${g}</h2><div id='qr-${g}'></div><hr>`);
      }
      newWin.document.write("<script src='https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js'><\/script>");
      newWin.document.write("<script>");
      for (let g in data.groups) {
        newWin.document.write(`new QRCode(document.getElementById("qr-${g}"), { text: "${g}", width: 200, height: 200 });`);
      }
      newWin.document.write("<\/script>");
    }

    loadData();
    renderGroups();
  </script>
</body>
</html>